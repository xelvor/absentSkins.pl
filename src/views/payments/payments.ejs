<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/styles/steam-login-modal.css">
    <link rel="stylesheet" href="../assets/styles/header.css">
    <link rel="stylesheet" href="../assets/styles/payments.css">
    <link rel="stylesheet" href="../assets/styles/scrollbar.css">
    <script src="../assets/scripts/steam.js"></script>
    <script src="../assets/scripts/odometer.js"></script>
    <script
    src="https://cdnjs.cloudflare.com/ajax/libs/odometer.js/0.4.7/odometer.min.js"
    integrity="sha512-v3fZyWIk7kh9yGNQZf1SnSjIxjAKsYbg6UQ+B+QxAZqJQLrN3jMjrdNwcxV6tis6S0s1xyVDZrDz9UoRLfRpWw=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
    ></script>
    <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/odometer.js/0.4.7/themes/odometer-theme-default.css"
    integrity="sha512-kMPqFnKueEwgQFzXLEEl671aHhQqrZLS5IP3HzqdfozaST/EgU+/wkM07JCmXFAt9GO810I//8DBonsJUzGQsQ=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
    />
</head>
<body>
    <header>
        <div class="header-left-side">
            <img class="header-logo" src="../assets/logo.png" alt="">
        </div>
        <div class="header-center">
            <a href="/exchanger"><span class="header-page">EXCHANGER</span></a>
            <a href="/mines"><span class="header-page">MINY</span></a>
        </div>
        <div class="header-right-side">
            <% if (req.session.logged) { %>
                <div class="header-wallet">
                    <img class="header-money-icon" src="https://www.absentskins.pl/assets/dollar.png" alt="">
                    <span class="header-money"><%= req.session.money%></span>
                  </div>
                <img class="header-avatar" src="<%= req.session.avatar %>" alt="">
                <button class="header-settings">
                    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="gear" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="25px" height="25px" class="button_icon svg-inline--fa fa-gear"><path fill="#ffffff" d="M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6c4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2c5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.3 28.2-18.9 44-25.4l12.5-57.1c2-9.1 9-16.3 18.2-17.8C227.3 1.2 241.5 0 256 0s28.7 1.2 42.5 3.5c9.2 1.5 16.2 8.7 18.2 17.8l12.5 57.1c15.8 6.5 30.6 15.1 44 25.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8c8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z" class=""></path></svg>
                </button>
            <% } else { %>
                <button onclick="loginWithSteam()" class="button-login-steam"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="steam-symbol" width="20px" height="20px"role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="LoginButton_icon svg-inline--fa fa-steam-symbol"><path fill="#ffffff" d="M395.5 177.5c0 33.8-27.5 61-61 61-33.8 0-61-27.3-61-61s27.3-61 61-61c33.5 0 61 27.2 61 61zm52.5.2c0 63-51 113.8-113.7 113.8L225 371.3c-4 43-40.5 76.8-84.5 76.8-40.5 0-74.7-28.8-83-67L0 358V250.7L97.2 290c15.1-9.2 32.2-13.3 52-11.5l71-101.7c.5-62.3 51.5-112.8 114-112.8C397 64 448 115 448 177.7zM203 363c0-34.7-27.8-62.5-62.5-62.5-4.5 0-9 .5-13.5 1.5l26 10.5c25.5 10.2 38 39 27.7 64.5-10.2 25.5-39.2 38-64.7 27.5-10.2-4-20.5-8.3-30.7-12.2 10.5 19.7 31.2 33.2 55.2 33.2 34.7 0 62.5-27.8 62.5-62.5zm207.5-185.3c0-42-34.3-76.2-76.2-76.2-42.3 0-76.5 34.2-76.5 76.2 0 42.2 34.3 76.2 76.5 76.2 41.9.1 76.2-33.9 76.2-76.2z" class=""></path></svg> Zaloguj przez Steam</button>
            <% } %>
        </div>
    </header>
    <div class="container">
        <div class="payments-box">
            <div class="payments-header">
                <div class="payments-header-short-bar"></div>
                <img class="payments-header-img" src="https://www.absentskins.pl/assets/wallet.svg" alt="">
                <div class="paymets-header-textes">
                    <span class="payments-header-text-title">DOŁADUJ KONTO</span>
                    <span class="payments-header-text-description">DOŁADUJ SWOJE KONTO JEDNĄ Z WIELU DOSTĘPNYCH METOD PŁATNOŚCI</span>
                </div>
                <div class="payments-header-long-bar"></div>
            </div>
            <div class="payments-container">
                <div class="payments-methods">
                    <div class="payment-method">
                        <img class="payment-method-img" src="https://www.absentskins.pl/assets/blik.svg" alt="">
                    </div>
                    <div class="payment-method">
                        <img class="payment-method-img" src="https://www.absentskins.pl/assets/p24.svg" alt="">
                    </div>
                    <div class="payment-method">
                        <img class="payment-method-img" src="https://www.absentskins.pl/assets/zen-cps.svg" alt="">
                    </div>
                    <div class="payment-method">
                        <img class="payment-method-img" src="https://www.absentskins.pl/assets/paysafecard.svg" alt="">
                    </div>
                    <div class="payment-method">
                        <img class="payment-method-img" src="https://www.absentskins.pl/assets/simpay-db.svg" alt="">
                    </div>
                    <div class="payment-method">
                        <img class="payment-method-img" src="https://www.absentskins.pl/assets/gift.svg" alt="">
                    </div>
                    <div class="payment-method">
                        <img class="payment-method-img" src="https://www.absentskins.pl/assets/skins.svg" alt="">
                    </div>
                    <div class="payment-method">
                        <img class="payment-method-img" src="https://www.absentskins.pl/assets/gift-paypal.svg" alt="">
                    </div>
                    <div class="payment-method">
                        <img class="payment-method-img" src="https://www.absentskins.pl/assets/skrill.svg" alt="">
                    </div>
                    <div class="payment-method">
                        <img class="payment-method-img" src="https://www.absentskins.pl/assets/bbp.svg" alt="">
                    </div>
                </div>
                <div class="payments-info">
                    <div class="payment-bonus">
                        <div class="payment-header">
                            <div class="payment-header-left-side">
                                <span class="payment-header-title">BONUS AKTYWNY! OTRZYMUJESZ:</span>
                                <div class="payment-header-sashes">
                                    <div class="payment-header-sash">
                                        <div class="payment-header-sash-icon">
                                            <img class="payment-header-sash-icon-img" src="https://www.absentskins.pl/assets/dollar.png" alt="">
                                        </div>
                                        <span class="payment-header-sash-text">5% WIĘCEJ PRZY DOŁADOWANIU</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="payment-bonus-info">
                            <div class="payment-bonus-code">UŻYTY KOD PROMOCYJNY: <span class="payment-bonus-code-color">BONUS5</span></div>
                            <button class="payment-bonus-button">ZAKTUALIZUJ KOD</button>
                        </div>
                    </div>
                    <div class="payment-form">
                        <div class="payment-form-inputs">
                            <div class="payment-form-input">
                                <span class="payment-form-input-title">Kwota doładowania</span>
                                <input minlength="1" min="1" value="0" id="input-price" class="payment-form-input-field" type="number" placeholder="0.00">
                            </div>

                            <div class="payment-form-input">
                                <span class="payment-form-input-title">Twój adres E-Mail</span>
                                <input class="payment-form-input-field" type="email" placeholder="Wprowadź adres E-Mail">
                            </div>
                        </div>
                        <div class="payment-form-buttons">
                            <button class="add-money-button">5.00 PLN</button>
                            <button class="add-money-button">20.00 PLN</button>
                            <button class="add-money-button">50.00 PLN</button>
                            <button class="add-money-button">100.00 PLN</button>
                            <button class="add-money-button">200.00 PLN</button>
                            <button class="add-money-button">500.00 PLN</button>
                        </div>
                        <div class="payment-data">
                            <div class="payment-header-left-side">
                                <span class="payment-data-title">OTRZYMASZ ŁĄCZNIE</span>
                                <span class="payment-data-description"><span class="payment-bonus-code-color">$</span> 0.00 PLN</span>
                                <span class="payment-data-description"><span class="payment-bonus-code-color">+ 5% bonusu (0.00 PLN)</span> zostało wliczone do sumy doładowania.</span>
                            </div>
                        </div>
                        <div class="payment-form-buttons">
                            <button class="deposit-money">DOŁADUJ KONTO</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

<script>
    const params = new URLSearchParams(window.location.search);
    const deposit = params.get('deposit');
    const error = params.get('error');

    if (deposit && deposit === 'true' && !error) {
        const amout = params.get('amout');

        iziToast.success({
            title: 'Sukces',
            message: `Pomyślnie doładowano konto o ${amout} PLN`,
            position: 'bottomRight'
        });
    } else if (error && error === 'true' && !deposit) {
        iziToast.error({
            title: 'Błąd',
            message: 'Wystąpił błąd podczas doładowywania konta',
            position: 'bottomRight'
        });
    }

    const addMoneyButtons = document.querySelectorAll('.add-money-button');
    const paymentFormInputField = document.querySelector('.payment-form-input-field');

    addMoneyButtons.forEach(button => {
        button.addEventListener('click', () => {
            paymentFormInputField.value = button.innerText.split(' ')[0];

            const price = paymentFormInputField.value;
            const bonus = price * 0.05;
            const total = parseFloat(price) + parseFloat(bonus);
            document.querySelector('.payment-data-description').innerHTML = `<span class="payment-bonus-code-color">$</span> ${total.toFixed(2)} PLN`;
            document.querySelector('.payment-data-description:nth-child(3)').innerHTML = `<span class="payment-bonus-code-color">+ 5% bonusu (${bonus.toFixed(2)} PLN)</span> zostało wliczone do sumy doładowania.`;
        });
    });

    const inputPrice = document.getElementById('input-price');
    inputPrice.addEventListener('input', () => {
        const price = inputPrice.value;
        const bonus = price * 0.05;
        const total = parseFloat(price) + parseFloat(bonus);
        document.querySelector('.payment-data-description').innerHTML = `<span class="payment-bonus-code-color">$</span> ${total.toFixed(2)} PLN`;
        document.querySelector('.payment-data-description:nth-child(3)').innerHTML = `<span class="payment-bonus-code-color">+ 5% bonusu (${bonus.toFixed(2)} PLN)</span> zostało wliczone do sumy doładowania.`;
    });

    const paymentsMethods = document.querySelectorAll('.payment-method');
    paymentsMethods[0].classList.add('active')

    paymentsMethods.forEach(method => {
        method.addEventListener('click', () => {
            paymentsMethods.forEach(method => {
                method.classList.remove('active');
            });
            method.classList.add('active');
        });
    });

    addEventListener('load', () => {
        const eventSource = new EventSource('http://localhost:8080/money/update-money');
    
        eventSource.onmessage = function (event) {
            const data = JSON.parse(event.data);
            const money = document.querySelector('.header-money');
            createOdometer(money, data.money);
        }
    })
    
    const depositMoney = document.querySelector('.deposit-money');
    depositMoney.addEventListener('click', () => {
        const price = inputPrice.value;
        const total = parseFloat(price)
        const email = document.querySelector('.payment-form-input-field').value;

        if (!email || email.length < 1) {
            return iziToast.error({
                title: 'Błąd',
                message: 'Wprowadź adres E-Mail',
                position: 'bottomRight'
            });
        }

        if (price < 1) {
            return iziToast.error({
                title: 'Błąd',
                message: 'Kwota doładowania musi być większa niż 1 PLN',
                position: 'bottomRight'
            });
        }

        if (price < 10) {
            return iziToast.error({
                title: 'Błąd',
                message: 'Minimalna kwota doładowania to 10 PLN',
                position: 'bottomRight'
            });
        }

        if (!Number.isInteger(parseFloat(price))) {
            return iziToast.error({
                title: 'Błąd',
                message: 'Kwota doładowania musi być liczbą całkowitą',
                position: 'bottomRight'
            });
        }

        const paymentMethod = document.querySelector('.payment-method.active img').src;
        const paymentMethodType = paymentMethod.split('/')[paymentMethod.split('/').length - 1].split('.')[0];

        window.location.href = `/payments/deposit?price=${total}&paymentMethod=${paymentMethodType}`;
    });
</script>